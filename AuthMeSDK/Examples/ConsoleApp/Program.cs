using System;
using System.Threading.Tasks;
using AuthMe.NET;
using AuthMe.NET.Models;

namespace AuthMe.Examples.Console
{
    /// <summary>
    /// Example console application demonstrating AuthMe.NET integration
    /// </summary>
    class Program
    {
        static async Task Main(string[] args)
        {
            System.Console.WriteLine("üîí AuthMe .NET Console Example");
            System.Console.WriteLine("===============================");
            System.Console.WriteLine();

            // Initialize AuthMe with your app credentials
            // IMPORTANT: Replace these placeholder values with your actual credentials from the AuthMe dashboard
            var config = new AuthMeConfig
            {
                AppId = "YOUR_APP_ID_HERE", // Get from AuthMe Dashboard ‚Üí Applications ‚Üí Your App ‚Üí App ID
                AppSecret = "YOUR_APP_SECRET_HERE", // Get from AuthMe Dashboard ‚Üí Applications ‚Üí Your App ‚Üí App Secret
                AppName = "Your Application Name", // Your application's display name
                CacheDurationSeconds = 3, // Cache duration for license validation (recommended: 3-5 seconds)
                HwidMethod = HwidMethod.Comprehensive, // Hardware ID collection method
                DiscordSupport = "discord.gg/your-server", // Your Discord support server (optional)
            };

            using var authMe = new AuthMeClient(config);



            // Validate configuration
            if (!config.IsValid())
            {
                System.Console.WriteLine("‚ùå Invalid configuration!");
                System.Console.WriteLine("Please replace the placeholder values in Program.cs with your actual credentials:");
                System.Console.WriteLine("");
                System.Console.WriteLine("Replace these placeholders:");
                System.Console.WriteLine("‚Ä¢ (ownerid) ‚Üí Your actual Owner ID");
                System.Console.WriteLine("‚Ä¢ (appsecret) ‚Üí Your actual App Secret");
                System.Console.WriteLine("‚Ä¢ namehere ‚Üí Your actual application name");
                System.Console.WriteLine("");
                System.Console.WriteLine("To get your credentials:");
                System.Console.WriteLine("1. Start your AuthMe admin dashboard: npm run dev");
                System.Console.WriteLine("2. Go to your AuthMe dashboard (usually http://localhost:3000)");
                System.Console.WriteLine("3. Select your application");
                System.Console.WriteLine("4. Navigate to the 'Credentials' tab");
                System.Console.WriteLine("5. Copy your Owner ID and App Secret");
                System.Console.WriteLine("");
                System.Console.WriteLine("Press any key to exit...");
                System.Console.ReadKey();
                return;
            }

            try
            {
                // Test connection first
                System.Console.WriteLine("Testing connection to AuthMe service...");
                var (success, message) = await authMe.TestConnectionAsync();
                
                if (!success)
                {
                    System.Console.WriteLine($" Connection failed: {message}");
                    System.Console.WriteLine("Please check your internet connection and configuration.");
                    System.Console.WriteLine("Press any key to exit...");
                    System.Console.ReadKey();
                    return;
                }

                System.Console.WriteLine("‚úÖ Connection successful!");
                System.Console.WriteLine();

                // Show hardware information
                System.Console.WriteLine("Hardware Information:");
                System.Console.WriteLine("--------------------");
                var hwInfo = authMe.GetHardwareInfo();
                foreach (var kvp in hwInfo)
                {
                    System.Console.WriteLine($"{kvp.Key}: {kvp.Value}");
                }
                System.Console.WriteLine();

                // üîê STEP 1: AUTHENTICATION GATE - This happens FIRST, before main application
                System.Console.WriteLine("üîê AuthMe License Validation");
                System.Console.WriteLine("============================");
                System.Console.Write("Enter your license key: ");
                var licenseKey = System.Console.ReadLine()?.Trim();

                if (string.IsNullOrEmpty(licenseKey))
                {
                    System.Console.WriteLine("‚ùå No license key provided");
                    System.Console.WriteLine("Press any key to exit...");
                    System.Console.ReadKey();
                    return;
                }

                // Authenticate using config settings for output customization
                var authResult = await authMe.AuthenticateAsync(licenseKey);

                if (authResult.IsSuccess)
                {
                    // ‚úÖ STEP 2: AUTHENTICATION SUCCESSFUL - START MAIN APPLICATION
                    await RunMainApplication(authResult.KeyData!);
                }
                else
                {
                    // ‚ùå STEP 3: AUTHENTICATION FAILED - DENY ACCESS TO MAIN APPLICATION
                    System.Console.WriteLine();

                    // Check for global ban first
                    bool isGloballyBanned = authResult.Message.Contains("Your IP/device combination has been banned", StringComparison.OrdinalIgnoreCase);

                    if (isGloballyBanned)
                    {
                        System.Console.WriteLine("üö® GLOBAL BAN DETECTED");
                        System.Console.WriteLine("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
                        System.Console.WriteLine("üö´ Your IP address and device have been globally banned.");
                        System.Console.WriteLine();
                        System.Console.WriteLine("This affects ALL license keys from your current location/device.");
                        System.Console.WriteLine();

                        // Extract ban reason from message
                        var reasonStart = authResult.Message.IndexOf("Reason: ") + 8;
                        var reasonEnd = authResult.Message.IndexOf(".", reasonStart);
                        if (reasonStart > 7 && reasonEnd > reasonStart)
                        {
                            var banReason = authResult.Message.Substring(reasonStart, reasonEnd - reasonStart);
                            System.Console.WriteLine($"üìù Ban Reason: {banReason}");
                            System.Console.WriteLine();
                        }

                        // Check if there's also a key-specific issue
                        if (authResult.Message.Contains("Additionally, this license key issue:"))
                        {
                            System.Console.WriteLine("Additionally, this specific license key has issues:");
                            System.Console.WriteLine();
                        }
                    }

                    // Show specific error messages based on the failure reason
                    if (authResult.KeyData != null)
                    {
                        var keyData = authResult.KeyData;

                        if (keyData.IsRevoked)
                        {
                            if (!isGloballyBanned) System.Console.WriteLine("üö´ Your license key has been revoked.");
                            else System.Console.WriteLine("üö´ License key status: REVOKED");
                            System.Console.WriteLine();
                            System.Console.WriteLine("This typically happens due to:");
                            System.Console.WriteLine("‚Ä¢ Violation of terms of service");
                            System.Console.WriteLine("‚Ä¢ Chargeback or payment dispute");
                            System.Console.WriteLine("‚Ä¢ Unauthorized key sharing");
                            System.Console.WriteLine();

                            // Extract key-specific reason if it's a combined message
                            if (isGloballyBanned && authResult.Message.Contains("Additionally, this license key issue:"))
                            {
                                var keyReasonStart = authResult.Message.IndexOf("Additionally, this license key issue: ") + 38;
                                var keyReasonEnd = authResult.Message.IndexOf(".", keyReasonStart);
                                if (keyReasonStart > 37 && keyReasonEnd > keyReasonStart)
                                {
                                    var keyReason = authResult.Message.Substring(keyReasonStart, keyReasonEnd - keyReasonStart);
                                    System.Console.WriteLine($"üìù Revocation Reason: {keyReason}");
                                }
                            }
                            else
                            {
                                System.Console.WriteLine($"üìù Revocation Reason: {authResult.Message}");
                            }
                        }
                        else if (keyData.IsSuspended)
                        {
                            if (!isGloballyBanned) System.Console.WriteLine("‚è∏Ô∏è Your license key has been suspended.");
                            else System.Console.WriteLine("‚è∏Ô∏è License key status: SUSPENDED");
                            System.Console.WriteLine();
                            System.Console.WriteLine("This is usually temporary and may be due to:");
                            System.Console.WriteLine("‚Ä¢ Pending payment verification");
                            System.Console.WriteLine("‚Ä¢ Account review in progress");
                            System.Console.WriteLine("‚Ä¢ Temporary security hold");
                            System.Console.WriteLine();

                            // Extract key-specific reason if it's a combined message
                            if (isGloballyBanned && authResult.Message.Contains("Additionally, this license key issue:"))
                            {
                                var keyReasonStart = authResult.Message.IndexOf("Additionally, this license key issue: ") + 38;
                                var keyReasonEnd = authResult.Message.IndexOf(".", keyReasonStart);
                                if (keyReasonStart > 37 && keyReasonEnd > keyReasonStart)
                                {
                                    var keyReason = authResult.Message.Substring(keyReasonStart, keyReasonEnd - keyReasonStart);
                                    System.Console.WriteLine($"üìù Suspension Reason: {keyReason}");
                                }
                            }
                            else
                            {
                                System.Console.WriteLine($"üìù Suspension Reason: {authResult.Message}");
                            }
                        }
                        else if (keyData.IsExpired)
                        {
                            System.Console.WriteLine("‚è∞ Your license key has expired.");
                            System.Console.WriteLine($"üìÖ Expired on: {keyData.ExpiresAt?.ToString("yyyy-MM-dd")}");
                            System.Console.WriteLine();
                            System.Console.WriteLine("üí° To continue using this application, please renew your license.");
                        }
                        else if (keyData.IsUsageLimitReached)
                        {
                            System.Console.WriteLine("üìä Your license key usage limit has been reached.");
                            System.Console.WriteLine($"üìà Usage: {keyData.UsageCount}/{keyData.MaxUses}");
                            System.Console.WriteLine();
                            System.Console.WriteLine("üí° Please upgrade your license for additional usage.");
                        }
                        else
                        {
                            System.Console.WriteLine("‚ùå License key validation failed.");
                            System.Console.WriteLine($"üìù Reason: {authResult.Message}");
                        }
                    }
                    else
                    {
                        System.Console.WriteLine("‚ùå License key validation failed.");
                        System.Console.WriteLine($"üìù Reason: {authResult.Message}");
                    }

                    if (authResult.IsSecurityViolation)
                    {
                        System.Console.WriteLine();
                        System.Console.WriteLine("üö® SECURITY VIOLATION DETECTED:");
                        System.Console.WriteLine("‚Ä¢ Key is being used on multiple devices");
                        System.Console.WriteLine("‚Ä¢ Hardware ID spoofing detected");
                        System.Console.WriteLine("‚Ä¢ Unauthorized key sharing");
                    }

                    // Always show support information
                    System.Console.WriteLine();
                    System.Console.WriteLine("üÜò Need help? Contact support:");
                    System.Console.WriteLine($"üí¨ Discord: {authMe.Config.DiscordSupport}");
                    System.Console.WriteLine("üìß If this is a mistake, please reach out to our support team.");

                    System.Console.WriteLine();
                    System.Console.WriteLine("Main application will not start.");
                }

                System.Console.WriteLine();
                System.Console.WriteLine("Press any key to exit...");
                System.Console.ReadKey();
            }
            catch (Exception ex)
            {
                System.Console.WriteLine($"‚ùå Application error: {ex.Message}");
                System.Console.WriteLine("Press any key to exit...");
                System.Console.ReadKey();
            }
        }

        /// <summary>
        /// üöÄ MAIN APPLICATION - This only runs AFTER successful authentication
        /// Replace this method with your actual application logic
        /// </summary>
        static async Task RunMainApplication(LicenseKeyData keyData)
        {
            // Clear the authentication screen
            System.Console.Clear();

            // Welcome to the ACTUAL application
            System.Console.WriteLine("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
            System.Console.WriteLine("‚ïë        YOUR APPLICATION NAME        ‚ïë");
            System.Console.WriteLine("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
            System.Console.WriteLine();
            System.Console.WriteLine($"üéâ Welcome! License: {keyData.Tier.ToUpper()}");
            System.Console.WriteLine($"üìÖ Expires: {(keyData.ExpiresAt?.ToString("yyyy-MM-dd") ?? "Never")}");
            System.Console.WriteLine($"üìä Usage: {keyData.UsageCount}{(keyData.IsUnlimited ? " (unlimited)" : $"/{keyData.MaxUses}")}");
            System.Console.WriteLine();

            // Show warnings if needed
            if (keyData.IsExpired)
            {
                System.Console.WriteLine("‚ö†Ô∏è  Warning: License is expired!");
            }

            if (keyData.IsUsageLimitReached)
            {
                System.Console.WriteLine("‚ö†Ô∏è  Warning: Usage limit reached!");
            }

            // üéØ YOUR ACTUAL APPLICATION FEATURES GO HERE
            System.Console.WriteLine("Available Features:");
            System.Console.WriteLine("==================");

            while (true)
            {
                System.Console.WriteLine();
                System.Console.WriteLine("1. üìä Advanced Analytics");
                System.Console.WriteLine("2. üéÆ Premium Features");
                System.Console.WriteLine("3. üîß Settings");
                System.Console.WriteLine("4. ‚ùì Help");
                System.Console.WriteLine("5. üö™ Exit");
                System.Console.WriteLine();
                System.Console.Write("Choose an option (1-5): ");

                var choice = System.Console.ReadLine();

                switch (choice)
                {
                    case "1":
                        System.Console.WriteLine("\nüìä Running Advanced Analytics...");
                        System.Console.WriteLine("Analytics data loaded successfully!");
                        await Task.Delay(1000); // Simulate work
                        break;

                    case "2":
                        System.Console.WriteLine("\nüéÆ Accessing Premium Features...");
                        System.Console.WriteLine("Premium features unlocked!");
                        await Task.Delay(1000); // Simulate work
                        break;

                    case "3":
                        System.Console.WriteLine("\nüîß Opening Settings...");
                        System.Console.WriteLine("Settings panel opened!");
                        await Task.Delay(1000); // Simulate work
                        break;

                    case "4":
                        System.Console.WriteLine("\n‚ùì Help Information:");
                        System.Console.WriteLine("This is your protected application!");
                        System.Console.WriteLine("Contact support: your-support@email.com");
                        break;

                    case "5":
                        System.Console.WriteLine("\nüëã Thank you for using our software!");
                        System.Console.WriteLine("Press any key to exit...");
                        System.Console.ReadKey();
                        return;

                    default:
                        System.Console.WriteLine("\n‚ùå Invalid option. Please choose 1-5.");
                        break;
                }
            }
        }
    }
}
